---
title: "Exploratory Data Analysis"
date: "07/10/2022"
author: "Jenny Yang"
output: 
  html_document:
  toc: true
  toc_float: true
---

## Introduction and set-up

In this section of the tutorial, we'll guide you through the process of Exploratory Data Analysis (EDA) using the Kiva dataset and prompt introduced in the **Getting Started** section. The purpose of EDA is to perform initial investigation on the data, look for interesting trends, relationships, and anomalies through the use of descriptive statistics and data visualization. The insights generated through this stage will motivate and inspire the subsequent analysis, modelling, and statistical tests performed at the next phase in your DataFest journey.

### Loading packages

Since you've already been through the **Getting Started** tutorial, your R environment is all set up! With the prompt in mind, let's take a look at the data. But first, let's load some useful packages. In this tutorial, we will mainly explore and visualize the data using `tidyverse`, a collection of incredibly useful packages for doing Data Science in $\texttt{R}$.

EXPLAIN WHAT THE OTHER PACKAGES ARE BRIEFLY

```{r load-packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(janitor)
library(countrycode)
library(colorblindr)
library(viridis)
```

### Overview of the Data

Recall the prompt: **Help understand what motivates people to lend money to developing-nation entrepreneurs and what factors are associated with paying these loans.** There are two parts of the prompt that we need to address, **motivation for lending** and **factors associated with repayment**.

From the file names and data dictionary, `lender_loans.csv`, `lenders.csv`, and `loans.csv` seem to be three most relevant files. We can take a quick peek at the data before diving more deeply in.

```{r read data, message = FALSE, warning = FALSE}
lender_loans <- read_csv("data/lender_loans.csv")
lenders <- read_csv("data/lenders.csv")
loans <- read_csv("data/loans.csv")
str(lender_loans)
str(lenders)
str(loans)
```

Using the `str` function, we can see that in `lender_loans`, we have 125,580 observations of 51 variables; in `lenders`, we have 15,000 observations of 18 variables; and in `loans`, we have 97,183 observations of 75 variables. We can also see the variable names, from which we can narrow down our scope to the variables that are relevant to the prompt for further exploration and analysis.

To investigate lenders' motivations, we can focus on `lender_loans` and `lenders`. Possible helpful variables that associate with each lender can include `whereabouts` (introductory description about lenders), `country_code`(lenders' country), `occupation` (lenders' occupation), as well as the time that each lender has been a member of Kiva (variables start with `member_since`). `loan_because` will also be revealing since the lenders are directly stating their reasons for lending. Yet, it is a non-numerical data. So, it requires different analytical approaches that will be covered later in the **Text Analysis** section.

Similarly, variables that will contribute to the repayment can include `loan_amount`, `sector`, `use`, `location.code` (borrowers' country). A larger `loan_amount` may be a larger investment that is more risky. Certain sectors may be more profitable than others, similar with `use`. The macroeconomic environment of a location can be exceptionally critical to the success of borrowers.

WHAT IS "USE"?

There are also some variables that may be relevant to both parts of the prompt, such as the time when the loan request was posted and the loan amount. For instance, in 2008, the world economy underwent a global financial crisis. We might expect that this would have simultaneously increased the demand and decreased the supply of loans. Additionally, we might expect increased defaults as borrowers struggle to repay existing loans. To explore these hypotheses and more, we begin our analysis.

## EDA

We begin by visualizing the distribution of potentially important variables .

### -- Loan amount --

Let's start simple. To get a general sense of the loan amount, we can plot a barchart with the `loan_amount` on the x-axis and the count on the y-axis. Barchart is one of the most basic and direct visualization graphs. We can also color the bars to see the proportion of loans in different statuses to add another layer of information.

USE BAR CHARTS FOR CATEGORICAL, HISTOGRAMS FOR CONTINUOUS. I PREFER TO HAVE PROPORTION ON THE Y-AXIS RATHER THAN COUNT. FIX LEGEND: CAPITALIZE STATUS, DESCRIPTIONS, REPLACE IN_REPAYMENT WITH REPAYMENT. LEGENDS SHOULD HAVE DESCRIPTIONS NOT VARIABLE NAMES - THERE'S A WAY TO MANUALLY CONTROL WHAT IS DISPLAYED IN THE LEGEND, BUT RENAMING VARIABLES IS AN EASY SHORTCUT

```{r loan_amount dist, message = FALSE, warning = FALSE}
ggplot(lender_loans, aes(x = loan_amount, fill = status, width = 0.1)) +
  geom_bar(stat = "bin", color = "black") +
  xlab("Loan amount") +
  ylab("Frequency") +
  scale_fill_OkabeIto()+
  ggtitle("Distribution of loan amount and the status of each loan amount")
```

TEXT WAS DISPLAYING ON SAME LINE AS GRAPH, START ON NEW LINE

From the graph above we can see that the loan amount has a unimodal, skewed right distribution. The majority of loans is concentrated below \$1000, while there are some large loans scattered on the right side of the graph. Through the color we can also tell that most loans are already paid, while a good proportion is still in repayment.

A summary table may be more direct to visualize the proportion of each status:

SORT BY PERCENT DESCENDING, FIX VARIABLE NAMES. COMMENT ON WHAT YOU SEE IN THE HISTOGRAM AND TABLE

```{r table}
status <- loans %>%
  drop_na(status) %>% # drop missing values by health variable
  group_by(status) %>% # specify categorical variable
  summarize(Frequency = n()) %>% # return counts / frequencies
  mutate(Percent = paste0(round(Frequency / nrow(loans) * 100, 2), "%"))
table1 <- status %>%
  arrange(desc(Percent))
knitr::kable(table1, "pipe")
```

### -- Loan amount and number of loans across year --

I THINK A LINE GRAPH WOULD BE BETTER FOR THIS, ALSO GRAPH TEXT IS TOO SMALL

Next, we investigate trends over time involving the value and number of loans. From the barchart below, we can see that both the total loan amount and the number of loans issued each year continued to grow until 2012. The highest loan amount borrowed was in the year 2011 at USD 40.2 million. Similarly, the highest of number of loans were taken in the year 2011 as well, at 30,738 loans. It appears that there was a sharp plummet in 2012, however, investigating further we see that the 2012 data only includes values up to April. Further, we verify by locating Kiva's publicly available financial reporting documents, that Kiva's fiscal year ends on December 31th each year. The data itself also contains clues. For all years under `posted_yr`, the corresponding `posted_month` goes from 1 to 12, except for 2012, where `posted_month` stops at 4. This means that the data include loans from January to December from 2005 to 2011, but for 2012, there's only data from January up to April. As a result, the data in 2012 may not reflect the whole year's performance. Hence, we have conclusively determined that the 2012 anomaly is just an artifact of data collection and must be considered in subsequent analysis.

```{r across year,out.width = "40%",header= FALSE, message = FALSE, warning = FALSE}

# Summarise loan amount by year
year_loan_amount <- loans %>%
  group_by(posted_yr) %>%
  summarise(Total_amount = sum(loan_amount) / 1000) %>%
  mutate(year = factor(posted_yr, posted_yr))

# Summarise loan count by year
year_loan_count <- loans %>%
  group_by(posted_yr) %>%
  summarise(counts = length(unique(loan_id))) %>%
  mutate(year = factor(posted_yr, posted_yr))

# Clean data
year_loan_amount <- na.omit(year_loan_amount)
year_loan_count <- na.omit(year_loan_count)

par(mfrow = c(1, 1))

# Plot loan amount by year
ggplot(year_loan_amount) +
  aes(x = year, y = Total_amount, fill = year, label = Total_amount) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, nudge_y = 1000) +
  theme(legend.position = "none") +
  xlab("Year") +
  ylab("Total loan amount in USD ('000)") +
  scale_fill_OkabeIto()+
  ggtitle("Distribution of Loan amount over the years")

# Plot loan count by year
ggplot(year_loan_count) +
  aes(x = year, y = counts, fill = year, label = counts) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, nudge_y = 1000) +
  theme(legend.position = "none") +
  xlab("Year") +
  ylab("Total number of loans") +
  scale_fill_OkabeIto()+
  ggtitle("Distribution of number of loans over the years")
```

### -- Loan amount and number of loans across country --

Next, we consider geographical trends in the Kiva data. Since there are too many countries participating in both lending and borrowing through Kiva, we picked top 10 country with the most transaction based on data in 2011, because 2011 has the most abundant data.

WHAT DO YOU MEAN BY TOO MANY? HOW MANY ARE THERE. BE SPECIFIC

*Geographical Distribution of Borrowers*

```{r loan distribution across borrower country, out.width = "40%", message = FALSE, warning = FALSE}
# Number of Loans
loans_country <- loans %>%
  group_by(location.country) %>%
  summarize(counts = length(unique(loan_id))) %>%
  arrange(desc(counts)) %>%
  mutate(country = factor(location.country, location.country))
top_10_num_loan <- head(loans_country, 10)

# Loan Amount
tot_loans_country <- loans %>%
  group_by(location.country) %>%
  summarize(tot_loans = sum(loan_amount) / 1000) %>%
  arrange(desc(tot_loans)) %>%
  mutate(country = factor(location.country, location.country))

top_10_tot_loan <- head(tot_loans_country, 10)

par(mfrow = c(1, 1))

# Bar Chart country vs No. of loans

ggplot(top_10_num_loan) +
  geom_bar(aes(country, counts, fill = country), stat = "identity") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  xlab("Country") +
  ylab("Total loan count") +
  scale_fill_viridis(
  discrete = TRUE,
  option = "D")+
  ggtitle("Top 10 borrower countries by number of loans")

# Bar Chart country was Loan Amount
ggplot(top_10_tot_loan) +
  geom_bar(aes(country, tot_loans, fill = country), stat = "identity") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  xlab("Country") +
  ylab("Total loan amount in USD ('000)") +
  scale_fill_viridis(
  discrete = TRUE,
  option = "D")+
  ggtitle("Top 10 borrower countries by total loan amount")
```

From the two graphs, we know that Peru had received both the highest number of loans, around 9500, and the largest amount of loan, about \$900,000 USD, between 2005 and 2012.

REPLACE THIS WITH A LINE GRAPH WITH TIME LIKE YOU HAVE FOR LENDERS

*Geographical Distribution of Lenders*

```{r Lenders Trend, message = FALSE, warning = FALSE, header = FALSE}

country <- aggregate(lender_loans$loan_amount, by = list(year = lender_loans$posted_yr, country = lender_loans$country_code), FUN = sum, na.rm = TRUE)

country_decoded <- country %>%
  rename("country_name" = "country", "loan_amount" = "x") %>%
  filter(country_name %in% c("US", "CA", "GB", "AU", "DE", "NL", "SE", "NO", "JP", "PH")) %>%
  mutate(country_name = countrycode(country_name, "iso2c", "country.name"))

ggplot(data = country_decoded, aes(x = year, y = log(loan_amount), color = country_name)) +
  geom_line() +
  xlab("Year") +
  ylab("Loan amount (log)") +
  guides(color = guide_legend(title = "Country")) +
  scale_fill_viridis(
  discrete = TRUE,
  option = "D")+
  ggtitle("Top 10 lender countries by total loan amount from 2005 to 2012")
```

Again, here in this graph, we picked top 10 countries with the most lender based on 2011. A line graph emphasizes the trend over years. We also took a log for the loan amount. This is because US has a significantly higher total loan amount compared to other countries, due to the fact that Kiva is based in the US. As a result, a log function would make the data more comparable on a line graph. All lines peak in 2011, and drop intensely in 2012, which matches the result presented in the last two graphs.

HOW DOES LOGGING CHANGE THE INTERPRETATION? RETHINK THE ORGANIZATION ABOVE, MAYBE PUT ALL OF THESE UNDER ONE HEADING IN THE SAME STYLE AS YOUR PART 1 AND PART 2, POSSIBLY IT COULD BE SOMETHING LIKE "LOOKING AT THE BIG PICTURE"

### -- Part 1: Lender Motivation --

Kiva provides a platform where borrowers post their credit needs, and lenders choose how much and to whom they lend; this part of the prompt asks us to investigate what motivates lenders.

The most direct way to investigate lender preferences is to utilize the variable `loan_because`.

SAY WHAT THIS VARIABLE CONTAINS

While the `loan_because` variable allows us to look directly at lenders self-reported motivation, analysis of this variable requires more advanced text processing which we will discuss in a later section. As a next-best option, we know look at the characteristics of borrowers in hopes of identifying patterns in lender preferences.

```{r Loan_because, warning = FALSE}
head(unique(lenders$loan_because))
```

An alternate way of approaching this part of the prompt is to attempt to infer lender motivation from lender and borrower characteristics. In this vein, one interesting question is which borrower characteristics impact their success at obtaining funding; using this line of thinking, we might try to infer lender motivation from the differences between funded and non-funded projects. Similarly, we might investigate how manifest lender preferences vary with lender characteristics.

```{r}
top_lenders <- lender_loans %>%
  filter(country_code %in% c("US", "CA", "GB", "AU", "DE", "NL", "SE", "NO", "JP", "PH"))

top_lender_borrow <- aggregate(top_lenders$loan_amount, by = list(lender_country = top_lenders$country_code, borrower_country <- top_lenders$location.country), FUN = sum, na.rm = TRUE) %>%
  mutate(lender_country = countrycode(lender_country, "iso2c", "country.name")) %>%
  arrange(desc(x)) %>%
  arrange(lender_country) %>%
  group_by(lender_country) %>%
  slice(1, 2, 3) %>%
  mutate(x = format(x, big.mark = ",", trim = TRUE)) %>%
  rename("Loan Amount (USD)" = "x", "Lender Country" = "lender_country", "Borrower Country" = "Group.2")

knitr::kable(top_lender_borrow, "pipe")
```

In the table above, we can see the top three recipient countries of each of the top ten lender countries. This graph shows that lenders may not necessarily prefer borrowers from their own countries.

THIS TABLE IS GOOD BUT IT'S TOO LONG. INSTEAD OF LISTING THE TOP THREE BORROWERS FOR EACH COUNTRY VERTICALLY, DO IT HORIZONTALLY SO THAT THERE IS ONE ROW FOR AUSTRALIA AND A COLUMN FOR TOP BORROWER, SECOND, THIRD. AND THEN DROP THE LOAN AMOUNT

OVERALL THIS SECTION SEEMS A LITTLE THIN, SOME OTHER THINGS YOU COULD ADD TO BE CONSISTENT WITH THE DISCUSSION ABOVE: MAKE A SIDE BY SIDE BAR GRAPH OF SECTOR, GENDER BROKEN BY WHETHER OR NOT LOANS WERE FUNDED.

### -- Part 2: Repayment Factors --

ADD INTRO TO REPAYMENT FACTORS. HOW ARE YOU GOING TO APPROACH THIS SECTION. DISCUSS THE MANY LOAN STATUS LEVELS AND EXPLAIN HOW YOU SIMPLIFIED IT IN TO PAID AND UNPAID.

#### Sector

The borrower's sector could have a strong impact on both the demand for loans and the ability of borrowers to repay their loans. Some sectors could need more liquid capital than others, thus making up a bigger proportion of loan requests on Kiva.com. On the other hand, lenders might have a preference for lending to certain sectors, driven either by personal priorities or a belief that some sectors may be more profitable than others, and hence more likely to repay their loans.

```{r Sector, Paid amount, message=FALSE, warning=FALSE}
sector_loan <-
  aggregate(lender_loans$loan_amount, by = list(sector = lender_loans$sector), FUN = sum)
sector_paid <-
  mutate(aggregate(lender_loans$paid_amount,
    by = list(sector = lender_loans$sector),
    FUN = sum, na.rm = TRUE
  ))

by_sector <- sector_loan %>%
  mutate(paid = sector_paid$x) %>%
  mutate(unpaid = sector_loan$x - paid) %>%
  rename(loan = x)

by_sector <- by_sector[order(by_sector$loan, decreasing = TRUE), ]
by_sector_paid <- select(by_sector, sector, paid) %>%
  mutate(status = "paid") %>%
  rename("amount" = "paid")
by_sector_unpaid <- select(by_sector, sector, unpaid) %>%
  mutate(status = "unpaid") %>%
  rename("amount" = "unpaid")
by_sector <- rbind(by_sector_paid, by_sector_unpaid) %>%
  group_by(sector)

ggplot(by_sector) +
  aes(x = reorder(sector, amount), y = amount, fill = status, label = amount) +
  geom_bar(stat = "identity", position = "stack") +
  theme() +
  coord_flip() +
  xlab("Sector") +
  ylab("Loan amount (USD)") +
  scale_fill_viridis(
  discrete = TRUE,
  option = "D")+
  ggtitle("Paid vs Unpaid Loan Amount by Sector")
```

The graph above shows that for most sectors, paid loans well exceed unpaid loans. Of the top five sectors in terms of loan amount, Agriculture has the highest proportion of unpaid loans. Of all sectors, Housing and Education have the highest unpaid loans, nearly 50%. Whether or not sector is an important factor that predicts the the borrowers' ability to repay the loans is thus meaningful to investigate more deeply.

WHAT IS THE PROPORTION FOR AGRICULTURE. WHICH SECTORS HAVE THE LOWEST PROPORTION OF UNPAID LOANS.

```{r Sector loan amount with gender, message = FALSE, warning = FALSE }

# Get unique borrower id and total male female borrower count
loan_sub <- loans %>%
  group_by(borrower_image_id) %>%
  summarize(total_m = sum(borrower_m_count), total_f = sum(borrower_f_count))

# Create new borrower type column based on conditions
loan_sub <- loan_sub %>%
  mutate(bor_type = if_else(total_m == 1 & total_f == 0, "Male",
    if_else(total_m == 0 & total_f == 1, "Female", "Group")
  ))

merge <- left_join(x = lender_loans, y = loan_sub, by = "borrower_image_id")

sec_gender_loan <- merge %>%
  group_by(sector, bor_type) %>%
  summarise(tot_amount = sum(loan_amount) / 1000) %>%
  arrange(desc(tot_amount))

par(mfrow = c(1, 1))

sec_gender_loan <- na.omit(sec_gender_loan)

ggplot(sec_gender_loan) +
  aes(x = reorder(sector, tot_amount), y = tot_amount, fill = bor_type, label = tot_amount) +
  geom_bar(stat = "identity", position = "stack") +
  theme() +
  coord_flip() +
  xlab("Sector") +
  ylab("Total loan amount (USD '000s)") +
  scale_fill_viridis(
  discrete = TRUE,
  option = "D")+
  ggtitle("Sector vs Loan Amount by Gender")
```

Next, we investigate gender within each sector. Overall, the total loan amount of female borrowers far exceeds that of male borrowers. Similarly, in most sectors there is a greater proportion of female borrowers. Nevertheless, in Transportation, Construction, and Manufacturing, there are males received a higher loan amount than females.

CAPITALIZE LEGEND, TAKE LOAN AMOUNT IN X AXIS OUT OF SCIENTIFIC NOTATION. COMMENT ON THE PAYMENT REPAYMENT DIFFERENCES. REMOVE GROUP LOANS FOR THIS ANALYSIS SO YOU ONLY HAVE MALE AND FEMALE. TEXT NEEDS TO START ON NEW LINE, NOT SAME LINE AS GRAPH. REMEMBER THAT THIS IS UNDER THE LOAN REPAYMENT SECTION, SOYOU NEED TO BRING IT BACK TO LOAN REPAYMENT. YOU NEED TO DO A LITTLE MORE ANALYSIS HERE TO MAKE THE APPROPRIATE COMMENTARY: STATE WHAT THE OVERALL PROPORTION OF MALE AND FEMALE BORROWERS IS AND THEN IDENTIFY SECTORS THAT HAVE MORE OR LESS FEMALES THAN THE OVERALL PROPORTION AND COMMENT ON THESE SECTORS. COMMENT ON THE GENDER MAKEUP OF THE SECTORS THAT YOU POINTED OUT AS HAVING EXTRA HIGH OR LOW REPAYMENT ABOVE.

### Conclusion

POSSIBEL START TO REWRITE: IN THIS SECTION, WE OBSERVED SERVERAL INTERESTING TRENDS IN REGARDS TO LENDER MOTIVATION AND LOAN REPAYMENT. IN PARTICULAR, WE NOTICED VARIABILITY IN \[SOMETHING\] IN TERMS OF \[SOMETHING ELSE\].

For instance, the variability in paid vs unpaid proportion in each `sector` could reflect a potential predictor of the borrower's ability to repay, yet it can also be due to the sheer difference in total loan amount in different sectors, as well as the economic structure in each of the borrowers' countries. Again, EDA is the very first step to observe superficial correlation in the data, and this tutorial only shows some of the options. You can also experiment other variables or other visualization presentations, which may inspire you to a completely different direction that could catch the judges' eyes!

END BY PREVIEWING THE NEXT SECTIONS.

For further more in-depth analysis, it's definitely worthy to test whether the discrepency discovered in variables in this section is statistically significant.
